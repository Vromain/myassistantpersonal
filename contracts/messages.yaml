openapi: 3.0.3
info:
  title: Messages API
  version: 1.0.0

paths:
  /messages:
    get:
      tags:
        - Messages
      summary: List messages
      description: |
        Retrieve messages from unified inbox with filtering and pagination (FR-005, FR-015).
        Messages are synchronized from connected platforms at least every 60 seconds (FR-004).
      operationId: listMessages
      parameters:
        - name: accountId
          in: query
          description: Filter by connected account ID
          schema:
            type: string
            format: uuid
        - name: platform
          in: query
          description: Filter by platform
          schema:
            type: string
            enum: [gmail, outlook, exchange, imap, facebook, instagram, whatsapp, slack, discord, telegram, signal]
        - name: categoryId
          in: query
          description: Filter by category ID
          schema:
            type: string
            format: uuid
        - name: readStatus
          in: query
          description: Filter by read/unread status
          schema:
            type: boolean
        - name: priorityLevel
          in: query
          description: Filter by priority level (FR-006, FR-015)
          schema:
            type: string
            enum: [low, medium, high]
        - name: isUrgent
          in: query
          description: Filter urgent messages only (FR-028)
          schema:
            type: boolean
        - name: hasAttachment
          in: query
          description: Filter messages with attachments (FR-027)
          schema:
            type: boolean
        - name: startDate
          in: query
          description: Filter messages after this date
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          description: Filter messages before this date
          schema:
            type: string
            format: date-time
        - name: sortBy
          in: query
          description: Sort field
          schema:
            type: string
            enum: [timestamp, priority, sender]
            default: timestamp
        - name: sortOrder
          in: query
          description: Sort order
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: limit
          in: query
          description: Maximum number of results per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          description: Number of results to skip (pagination)
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Messages retrieved successfully
          headers:
            X-Total-Count:
              schema:
                type: integer
              description: Total number of messages matching filters
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                required:
                  - messages
                  - total
                  - limit
                  - offset
                properties:
                  messages:
                    type: array
                    items:
                      $ref: './schemas.yaml#/components/schemas/Message'
                  total:
                    type: integer
                    description: Total count of messages
                    example: 485
                  limit:
                    type: integer
                    example: 50
                  offset:
                    type: integer
                    example: 0
              example:
                messages:
                  - id: "770e8400-e29b-41d4-a716-446655440002"
                    connectedAccountId: "660e8400-e29b-41d4-a716-446655440001"
                    platform: "gmail"
                    senderName: "Alice Smith"
                    senderIdentifier: "alice@company.com"
                    subject: "Q4 Budget Review"
                    preview: "Hi team, let's schedule our Q4 budget review..."
                    messageTimestamp: "2025-11-16T13:45:00Z"
                    priorityScore: 85
                    priorityLevel: "high"
                    isUrgent: true
                    readStatus: false
                total: 485
                limit: 50
                offset: 0
        '400':
          $ref: './schemas.yaml#/components/responses/BadRequest'
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

  /messages/{messageId}:
    get:
      tags:
        - Messages
      summary: Get message details
      description: Retrieve full message content including HTML, attachments, and metadata (FR-007)
      operationId: getMessage
      parameters:
        - name: messageId
          in: path
          required: true
          description: Message ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Message retrieved successfully
          content:
            application/json:
              schema:
                $ref: './schemas.yaml#/components/schemas/Message'
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '404':
          $ref: './schemas.yaml#/components/responses/NotFound'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

    delete:
      tags:
        - Messages
      summary: Delete message
      description: Soft delete a message from the unified inbox (FR-026)
      operationId: deleteMessage
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Message deleted successfully
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '404':
          $ref: './schemas.yaml#/components/responses/NotFound'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

    patch:
      tags:
        - Messages
      summary: Update message properties
      description: Update message category, priority, or other properties
      operationId: updateMessage
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                categoryId:
                  type: string
                  format: uuid
                  description: Assign message to category (FR-013)
                  nullable: true
                readStatus:
                  type: boolean
                  description: Mark as read/unread (FR-009)
                isUrgent:
                  type: boolean
                  description: Flag/unflag as urgent
            example:
              categoryId: "880e8400-e29b-41d4-a716-446655440003"
              readStatus: true
      responses:
        '200':
          description: Message updated successfully
          content:
            application/json:
              schema:
                $ref: './schemas.yaml#/components/schemas/Message'
        '400':
          $ref: './schemas.yaml#/components/responses/BadRequest'
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '404':
          $ref: './schemas.yaml#/components/responses/NotFound'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

  /messages/{messageId}/read:
    put:
      tags:
        - Messages
      summary: Mark message as read
      description: |
        Mark message as read. Read status is synced bidirectionally with the original platform (FR-009).
      operationId: markMessageRead
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Message marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  readStatus:
                    type: boolean
                    example: true
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '404':
          $ref: './schemas.yaml#/components/responses/NotFound'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

    delete:
      tags:
        - Messages
      summary: Mark message as unread
      description: Mark message as unread. Synced with original platform (FR-009).
      operationId: markMessageUnread
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Message marked as unread
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  readStatus:
                    type: boolean
                    example: false
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '404':
          $ref: './schemas.yaml#/components/responses/NotFound'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

  /messages/{messageId}/archive:
    put:
      tags:
        - Messages
      summary: Archive message
      description: Move message to archive (FR-026)
      operationId: archiveMessage
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Message archived successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  archivedAt:
                    type: string
                    format: date-time
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '404':
          $ref: './schemas.yaml#/components/responses/NotFound'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

    delete:
      tags:
        - Messages
      summary: Unarchive message
      description: Move message back to inbox
      operationId: unarchiveMessage
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Message unarchived successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  archivedAt:
                    type: string
                    nullable: true
                    example: null
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '404':
          $ref: './schemas.yaml#/components/responses/NotFound'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

  /messages/{messageId}/reply:
    post:
      tags:
        - Messages
      summary: Reply to message
      description: |
        Send a reply to a message directly from the unified inbox (FR-008).
        Supports text content, HTML formatting, and file attachments (FR-027).
      operationId: replyToMessage
      parameters:
        - name: messageId
          in: path
          required: true
          description: Message ID to reply to
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  description: Reply message content
                  minLength: 1
                contentHtml:
                  type: string
                  description: HTML formatted reply content
                attachments:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: File attachments
            example:
              content: "Thanks for the update. I'll review and get back to you by EOD."
      responses:
        '201':
          description: Reply sent successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - id
                  - messageId
                  - status
                  - sentAt
                properties:
                  id:
                    type: string
                    format: uuid
                    description: Reply message ID
                  messageId:
                    type: string
                    format: uuid
                    description: Original message ID
                  status:
                    type: string
                    enum: [sent, pending, failed]
                    description: Send status
                  sentAt:
                    type: string
                    format: date-time
                    description: When reply was sent
              example:
                id: "890e8400-e29b-41d4-a716-446655440005"
                messageId: "770e8400-e29b-41d4-a716-446655440002"
                status: "sent"
                sentAt: "2025-11-16T14:30:00Z"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: './schemas.yaml#/components/schemas/Error'
              examples:
                emptyContent:
                  value:
                    code: "EMPTY_CONTENT"
                    message: "Reply content cannot be empty"
                fileTooLarge:
                  value:
                    code: "FILE_TOO_LARGE"
                    message: "Attachment exceeds maximum size of 25MB"
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '404':
          $ref: './schemas.yaml#/components/responses/NotFound'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

  /messages/bulk/mark-read:
    post:
      tags:
        - Messages
      summary: Bulk mark messages as read
      description: Mark multiple messages as read in a single operation
      operationId: bulkMarkRead
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - messageIds
              properties:
                messageIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 1
                  maxItems: 100
                  description: Array of message IDs to mark as read
            example:
              messageIds:
                - "770e8400-e29b-41d4-a716-446655440002"
                - "770e8400-e29b-41d4-a716-446655440003"
                - "770e8400-e29b-41d4-a716-446655440004"
      responses:
        '200':
          description: Messages marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  updatedCount:
                    type: integer
                    description: Number of messages successfully updated
                    example: 3
                  failedIds:
                    type: array
                    items:
                      type: string
                      format: uuid
                    description: IDs of messages that failed to update
                    example: []
        '400':
          $ref: './schemas.yaml#/components/responses/BadRequest'
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

  /messages/bulk/archive:
    post:
      tags:
        - Messages
      summary: Bulk archive messages
      description: Archive multiple messages in a single operation (FR-026)
      operationId: bulkArchive
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - messageIds
              properties:
                messageIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 1
                  maxItems: 100
            example:
              messageIds:
                - "770e8400-e29b-41d4-a716-446655440002"
                - "770e8400-e29b-41d4-a716-446655440003"
      responses:
        '200':
          description: Messages archived
          content:
            application/json:
              schema:
                type: object
                properties:
                  updatedCount:
                    type: integer
                    example: 2
                  failedIds:
                    type: array
                    items:
                      type: string
                      format: uuid
                    example: []
        '400':
          $ref: './schemas.yaml#/components/responses/BadRequest'
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

  /messages/bulk/delete:
    post:
      tags:
        - Messages
      summary: Bulk delete messages
      description: Delete multiple messages in a single operation (FR-026)
      operationId: bulkDelete
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - messageIds
              properties:
                messageIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 1
                  maxItems: 100
            example:
              messageIds:
                - "770e8400-e29b-41d4-a716-446655440002"
                - "770e8400-e29b-41d4-a716-446655440003"
      responses:
        '200':
          description: Messages deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deletedCount:
                    type: integer
                    example: 2
                  failedIds:
                    type: array
                    items:
                      type: string
                      format: uuid
                    example: []
        '400':
          $ref: './schemas.yaml#/components/responses/BadRequest'
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

  /messages/stats:
    get:
      tags:
        - Messages
      summary: Get message statistics
      description: Get current message counts and statistics
      operationId: getMessageStats
      responses:
        '200':
          description: Message statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalMessages:
                    type: integer
                    example: 1250
                  unreadCount:
                    type: integer
                    example: 42
                  urgentCount:
                    type: integer
                    example: 5
                  archivedCount:
                    type: integer
                    example: 380
                  byPlatform:
                    type: object
                    additionalProperties:
                      type: integer
                    example:
                      gmail: 720
                      whatsapp: 320
                      slack: 210
                  byPriority:
                    type: object
                    additionalProperties:
                      type: integer
                    example:
                      high: 180
                      medium: 750
                      low: 320
        '401':
          $ref: './schemas.yaml#/components/responses/Unauthorized'
        '429':
          $ref: './schemas.yaml#/components/responses/RateLimitExceeded'
        '500':
          $ref: './schemas.yaml#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
