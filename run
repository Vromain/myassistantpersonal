#!/usr/bin/env bash
set -euo pipefail
if [ -z "${BASH_VERSION:-}" ]; then
  echo "[run] Please run this script with bash: bash run or ./run"
  exit 1
fi

BACKEND_DIR="backend"
FRONTEND_DIR="flutter_app"
BACKEND_PORT=${BACKEND_PORT:-3005}
FRONTEND_PORT=${FRONTEND_PORT:-54104}
USE_CHROME=${USE_CHROME:-auto}

ensure_port_free() {
  local port="$1"
  local pids
  pids=$(lsof -ti :"$port" || true)
  if [ -n "$pids" ]; then
    echo "[run] Freeing port $port (killing: $pids) ..."
    echo "$pids" | xargs -r kill -9 || true
    sleep 1
  fi
}

# Force default ports and free them if busy
ensure_port_free "$BACKEND_PORT"
ensure_port_free "$FRONTEND_PORT"

export FRONTEND_URL="http://localhost:$FRONTEND_PORT"

if ! command -v npm >/dev/null 2>&1; then echo "[run] npm not found in PATH"; exit 1; fi
if ! command -v flutter >/dev/null 2>&1; then echo "[run] flutter not found in PATH"; echo "[run] Ensure Flutter is installed and added to PATH"; exit 1; fi

cd "$BACKEND_DIR"
echo "[run] Starting backend on port $BACKEND_PORT..."
PORT=$BACKEND_PORT FRONTEND_URL=$FRONTEND_URL npm run dev &
BACKEND_PID=$!

cd "../$FRONTEND_DIR"
echo "[run] Starting Flutter web on http://localhost:$FRONTEND_PORT ..."

# Decide device: chrome if requested or available, fallback to web-server
should_use_chrome=false
if [ "$USE_CHROME" = "1" ]; then
  should_use_chrome=true
elif [ "$USE_CHROME" = "auto" ]; then
  if command -v google-chrome >/dev/null 2>&1 || [ -x "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" ]; then
    should_use_chrome=true
  fi
fi

if [ "$should_use_chrome" = true ]; then
  echo "[run] Using Chrome device for improved hot reload"
  flutter run -d chrome --web-port "$FRONTEND_PORT" --web-hostname localhost
else
  flutter run -d web-server --web-port "$FRONTEND_PORT" --web-hostname localhost
fi

sleep 1
echo "[run] Backend:  http://localhost:$BACKEND_PORT"
echo "[run] Frontend: http://localhost:$FRONTEND_PORT"

cleanup() {
  echo "[run] Stopping..."
  kill "$BACKEND_PID" >/dev/null 2>&1 || true
}
trap cleanup INT TERM EXIT

# Keep script attached to Flutter process to accept hot reload keys
wait "$BACKEND_PID" || true
