#!/usr/bin/env bash
set -euo pipefail
if [ -z "${BASH_VERSION:-}" ]; then
  echo "[run] Please run this script with bash: bash run or ./run"
  exit 1
fi

BACKEND_DIR="backend"
FRONTEND_DIR="flutter_app"
BACKEND_PORT=${BACKEND_PORT:-3005}
FRONTEND_PORT=${FRONTEND_PORT:-54104}

find_free_port() {
  local port="$1"
  local max_port=65535
  while lsof -ti :"$port" >/dev/null 2>&1; do
    port=$((port+1))
    if [ "$port" -gt "$max_port" ]; then
      echo "[run] No free port found" >&2
      exit 1
    fi
  done
  echo "$port"
}

# Select free ports if defaults are busy
FREE_BACKEND_PORT=$(find_free_port "$BACKEND_PORT")
FREE_FRONTEND_PORT=$(find_free_port "$FRONTEND_PORT")

export FRONTEND_URL="http://localhost:$FREE_FRONTEND_PORT"

if ! command -v npm >/dev/null 2>&1; then echo "[run] npm not found in PATH"; exit 1; fi
if ! command -v flutter >/dev/null 2>&1; then echo "[run] flutter not found in PATH"; echo "[run] Ensure Flutter is installed and added to PATH"; exit 1; fi

cd "$BACKEND_DIR"
echo "[run] Starting backend on port $FREE_BACKEND_PORT..."
PORT=$FREE_BACKEND_PORT FRONTEND_URL=$FRONTEND_URL npm run dev &
BACKEND_PID=$!

cd "../$FRONTEND_DIR"
echo "[run] Starting Flutter web on http://localhost:$FREE_FRONTEND_PORT ..."
flutter run -d web-server --web-port "$FREE_FRONTEND_PORT" --web-hostname localhost &
FRONTEND_PID=$!

sleep 3
echo "[run] Backend:  http://localhost:$FREE_BACKEND_PORT"
echo "[run] Frontend: http://localhost:$FREE_FRONTEND_PORT"

trap 'echo "[run] Stopping..."; kill "$BACKEND_PID" "$FRONTEND_PID"' INT TERM
wait
